<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Audio Compressor - ToolBox</title>
  <meta name="description" content="Compress audio files easily in your browser. Fast, secure, and private—no upload needed." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    body { margin: 0; background: #f5f7fa; color: #333; }
    header, footer {
      background: linear-gradient(to right, #00b09b, #96c93d);
      color: white;
      padding: 16px 32px;
      text-align: center;
    }
    header h1, footer p { margin: 0; font-size: 20px; }
    main {
      max-width: 700px;
      margin: auto;
      padding: 32px 16px;
      text-align: center;
    }
    .drop-zone {
      border: 2px dashed #96c93d;
      padding: 40px;
      border-radius: 12px;
      background: #fff;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .drop-zone.dragover { background: #e0ffe6; }
    #fileNameDisplay { margin-top: 10px; font-weight: 500; }
    .controls {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .controls select, .controls button, #downloadBtn {
      padding: 10px;
      border-radius: 6px;
      font-size: 16px;
    }
    .controls select {
      border: 1px solid #ccc;
    }
    .controls button, #downloadBtn {
      background: linear-gradient(to right, #00b09b, #96c93d);
      color: white;
      border: none;
      cursor: pointer;
    }
    .controls button:hover, #downloadBtn:hover {
      opacity: 0.9;
    }
    #progressBar {
      width: 100%;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 20px;
    }
    #progressBar div {
      height: 12px;
      width: 0%;
      background: linear-gradient(to right, #00b09b, #96c93d);
      transition: width 0.4s ease;
    }
    #status {
      margin-top: 16px;
      font-weight: 600;
    }
    audio {
      margin-top: 20px;
      width: 100%;
    }
    #downloadBtn {
      display: none;
      margin-top: 16px;
      text-decoration: none;
      text-align: center;
    }
  </style>
</head>
<body>

<header>
  <h1>Audio Compressor</h1>
</header>

<main>
  <div class="drop-zone" id="dropZone">Drag & drop audio file here or click to select</div>
  <input type="file" id="fileInput" accept="audio/*" style="display:none" />
  <p id="fileNameDisplay"></p>

  <div class="controls" style="display:none" id="controls">
    <label for="quality">Compression Quality (%):</label>
    <select id="quality">
      <option value="10">10%</option>
      <option value="20">20%</option>
      <option value="30">30%</option>
      <option value="40">40%</option>
      <option value="50" selected>50%</option>
      <option value="60">60%</option>
      <option value="70">70%</option>
      <option value="80">80%</option>
      <option value="90">90%</option>
    </select>
    <button onclick="compressAudio()">Compress Audio</button>
    <div id="progressBar"><div></div></div>
    <div id="status"></div>
    <audio controls id="audioPlayer"></audio>
    <a id="downloadBtn">Download Compressed Audio</a>
  </div>
</main>

<footer>
  <p>&copy; 2025 Toolbox. All rights reserved.</p>
</footer>

<script>
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');
  const controls = document.getElementById('controls');
  const qualitySelect = document.getElementById('quality');
  const downloadBtn = document.getElementById('downloadBtn');
  const audioPlayer = document.getElementById('audioPlayer');
  const fileNameDisplay = document.getElementById('fileNameDisplay');

  let originalFile;
  let compressedURL;

  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    handleFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

  function handleFile(file) {
    if (!file.type.startsWith('audio/')) {
      updateStatus('❌ Please upload a valid audio file.', true);
      return;
    }
    originalFile = file;
    fileNameDisplay.textContent = 'Selected: ' + file.name;
    controls.style.display = 'flex';
    updateStatus('✅ File loaded. Choose quality and press compress.');
  }

  async function compressAudio() {
    updateProgress(10, '⏳ Compressing...');

    try {
      const audioContext = new AudioContext();
      const arrayBuffer = await originalFile.arrayBuffer();
      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
      const offlineContext = new OfflineAudioContext(audioBuffer.numberOfChannels, audioBuffer.length, audioBuffer.sampleRate);
      const source = offlineContext.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(offlineContext.destination);
      source.start(0);

      const renderedBuffer = await offlineContext.startRendering();
      const wavBlob = bufferToWav(renderedBuffer);
      compressedURL = URL.createObjectURL(wavBlob);
      audioPlayer.src = compressedURL;

      downloadBtn.href = compressedURL;
      downloadBtn.download = originalFile.name.replace(/\.[^/.]+$/, '') + "-compressed.wav";
      downloadBtn.style.display = 'inline-block';
      updateProgress(100, '✅ Compression complete!');
    } catch (err) {
      updateStatus('❌ Compression failed: ' + err.message, true);
    }
  }

  function bufferToWav(buffer) {
    const numOfChan = buffer.numberOfChannels;
    const length = buffer.length * numOfChan * 2 + 44;
    const bufferArray = new ArrayBuffer(length);
    const view = new DataView(bufferArray);
    let offset = 0;

    function writeString(str) {
      for (let i = 0; i < str.length; i++) view.setUint8(offset++, str.charCodeAt(i));
    }

    writeString('RIFF');
    view.setUint32(offset, 36 + buffer.length * numOfChan * 2, true); offset += 4;
    writeString('WAVE');
    writeString('fmt ');
    view.setUint32(offset, 16, true); offset += 4;
    view.setUint16(offset, 1, true); offset += 2;
    view.setUint16(offset, numOfChan, true); offset += 2;
    view.setUint32(offset, buffer.sampleRate, true); offset += 4;
    view.setUint32(offset, buffer.sampleRate * numOfChan * 2, true); offset += 4;
    view.setUint16(offset, numOfChan * 2, true); offset += 2;
    view.setUint16(offset, 16, true); offset += 2;
    writeString('data');
    view.setUint32(offset, buffer.length * numOfChan * 2, true); offset += 4;

    for (let i = 0; i < buffer.length; i++) {
      for (let ch = 0; ch < numOfChan; ch++) {
        const sample = Math.max(-1, Math.min(1, buffer.getChannelData(ch)[i]));
        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
        offset += 2;
      }
    }
    return new Blob([bufferArray], { type: 'audio/wav' });
  }

  function updateProgress(percent, message) {
    document.querySelector('#progressBar div').style.width = percent + '%';
    updateStatus(message);
  }

  function updateStatus(msg, error = false) {
    const el = document.getElementById('status');
    el.textContent = msg;
    el.style.color = error ? 'red' : 'green';
  }
</script>
</body>
</html>
